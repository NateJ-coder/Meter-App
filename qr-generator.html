<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator - Fuzio Meter Readings</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">‚ö° Fuzio Meter Readings</div>
        <ul class="nav-links">
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="meters.html">Meter Register</a></li>
            <li><a href="qr-generator.html" class="active">QR Codes</a></li>
        </ul>
    </nav>

    <main class="container">
        <header class="page-header">
            <h1>QR Code Generator</h1>
            <p class="subtitle">Generate QR codes for meter reading access</p>
        </header>

        <section class="card">
            <div class="card-header">
                <h2>Select Scheme</h2>
                <button class="btn btn-secondary" onclick="loadSchemes()">üîÑ Refresh Schemes</button>
            </div>
            <div class="form-group">
                <label for="scheme-select">Scheme</label>
                <select id="scheme-select" onchange="generateQR()">
                    <option value="">-- Select a scheme --</option>
                </select>
            </div>
            <div class="info-box" style="background: #e7f3ff; border-left-color: #2196F3;">
                <strong>‚ÑπÔ∏è One QR code per scheme</strong><br>
                The bulk meter serves the entire scheme. When scanned, the reader will capture the bulk meter reading first, then walk through all submeters across all buildings in the scheme.
            </div>
        </section>

        <section class="card" id="qr-output" style="display: none;">
            <h2>QR Code</h2>
            <div id="meter-info" class="info-box mb-2"></div>
            <div style="text-align: center; margin: 2rem 0;">
                <img id="qr-image" alt="QR Code" style="max-width: 300px; border: 1px solid #ccc; padding: 10px; background: white;">
            </div>
            <div class="form-group">
                <label>Reader URL</label>
                <input type="text" id="reader-url" readonly onclick="this.select()">
                <small class="form-help">Click to select and copy, or click the button below to test</small>
            </div>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="testReaderLink()">üîó Test Reader Link</button>
                <button class="btn btn-primary" onclick="downloadQR()">Download QR Code</button>
                <button class="btn btn-secondary" onclick="printQR()">Print QR Code</button>
            </div>
        </section>

        <section class="card">
            <h2>Instructions</h2>
            <ol>
                <li>Select a scheme from the dropdown</li>
                <li>A QR code will be generated for that scheme's bulk meter</li>
                <li><strong>For testing:</strong> Click "Test Reader Link" button to open in a new tab</li>
                <li>Download or print the QR code</li>
                <li>Attach the QR code to the scheme's bulk meter location</li>
            </ol>
            <p class="text-muted mt-2">
                <strong>Workflow:</strong> When a reader scans the QR code, they'll capture the bulk meter reading first, then the app will automatically walk them through all submeters across all buildings in the scheme (organized by building and unit number).
            </p>
            <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107; margin-top: 1rem;">
                <strong>‚ö†Ô∏è Current Limitation (localStorage skeleton):</strong><br>
                This skeleton uses browser localStorage, so QR codes only work when scanned <strong>on the same device and browser</strong> where meters were created.
                <br><br>
                <strong>For production:</strong> Add a backend (Phase 2) so data is accessible from any device. Then QR codes will work on field readers' phones.
                <br><br>
                <strong>For now:</strong> Use the "Test Reader Link" button to test the workflow on this computer.
            </div>
        </section>
    </main>

    <script type="module">
        import { storage } from './assets/storage.js';

        // Load schemes into dropdown (only schemes with bulk meters)
        window.loadSchemes = function() {
            const schemes = storage.getAll('schemes');
            const select = document.getElementById('scheme-select');
            
            // Clear existing options except the first placeholder
            select.innerHTML = '<option value="">-- Select a scheme --</option>';
            
            if (schemes.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'No schemes found. Create schemes in Meter Register first.';
                select.appendChild(option);
                return;
            }
            
            // Find schemes that have a bulk meter
            const schemesWithBulk = schemes.filter(scheme => {
                const bulkMeter = storage.getAll('meters').find(m => 
                    m.meter_type === 'BULK' && m.scheme_id === scheme.id
                );
                return !!bulkMeter;
            });

            if (schemesWithBulk.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'No schemes with bulk meters found.';
                select.appendChild(option);
                return;
            }
            
            schemesWithBulk.forEach(scheme => {
                const buildings = storage.getBuildings(scheme.id);
                const allUnits = [];
                buildings.forEach(b => {
                    allUnits.push(...storage.getUnits(b.id));
                });
                const unitIds = allUnits.map(u => u.id);
                const submeters = storage.getAll('meters').filter(m => 
                    m.meter_type === 'UNIT' && unitIds.includes(m.unit_id)
                );
                
                let label = scheme.name;
                label += ` (${buildings.length} buildings, ${submeters.length} submeters)`;
                
                const option = document.createElement('option');
                option.value = scheme.id;
                option.textContent = label;
                select.appendChild(option);
            });
        };

        window.generateQR = function() {
            const schemeId = document.getElementById('scheme-select').value;
            if (!schemeId) {
                document.getElementById('qr-output').style.display = 'none';
                return;
            }

            const scheme = storage.get('schemes', schemeId);
            
            // Find the bulk meter for this scheme
            const bulkMeter = storage.getAll('meters').find(m => 
                m.meter_type === 'BULK' && m.scheme_id === schemeId
            );

            if (!bulkMeter) {
                alert('No bulk meter found for this scheme');
                return;
            }

            // Count buildings and submeters
            const buildings = storage.getBuildings(schemeId);
            const allUnits = [];
            buildings.forEach(b => {
                allUnits.push(...storage.getUnits(b.id));
            });
            const unitIds = allUnits.map(u => u.id);
            const submeters = storage.getAll('meters').filter(m => 
                m.meter_type === 'UNIT' && unitIds.includes(m.unit_id)
            );
            
            // Build reader URL with scheme_id
            const baseUrl = window.location.origin + window.location.pathname.replace('qr-generator.html', '');
            const readerUrl = `${baseUrl}reader.html?scheme_id=${schemeId}`;
            
            // Generate QR code using API
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(readerUrl)}`;
            
            // Display scheme info
            let infoHtml = `<strong>Scheme:</strong> ${scheme.name}<br>`;
            infoHtml += `<strong>Buildings:</strong> ${buildings.length}<br>`;
            infoHtml += `<strong>Bulk Meter:</strong> ${bulkMeter.meter_number}<br>`;
            infoHtml += `<strong>Submeters:</strong> ${submeters.length} units<br>`;
            infoHtml += `<strong>Total Steps:</strong> ${submeters.length + 1} (bulk + all submeters)`;
            
            document.getElementById('meter-info').innerHTML = infoHtml;
            document.getElementById('qr-image').src = qrApiUrl;
            document.getElementById('reader-url').value = readerUrl;
            document.getElementById('qr-output').style.display = 'block';
        };

        window.downloadQR = function() {
            const qrImage = document.getElementById('qr-image');
            const schemeId = document.getElementById('scheme-select').value;
            const scheme = storage.get('schemes', schemeId);
            const link = document.createElement('a');
            link.href = qrImage.src;
            link.download = `scheme-qr-${scheme.name.replace(/\s+/g, '-')}.png`;
            link.click();
        };

        window.testReaderLink = function() {
            const readerUrl = document.getElementById('reader-url').value;
            if (readerUrl) {
                window.open(readerUrl, '_blank');
            }
        };

        window.printQR = function() {
            const qrImage = document.getElementById('qr-image').src;
            const meterInfo = document.getElementById('meter-info').innerHTML;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print QR Code</title>
                    <style>
                        body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
                        .info { text-align: left; margin: 1rem auto; max-width: 400px; }
                        img { max-width: 300px; margin: 1rem 0; }
                    </style>
                </head>
                <body>
                    <h1>Meter Reading QR Code</h1>
                    <div class="info">${meterInfo}</div>
                    <img src="${qrImage}" alt="QR Code">
                    <p>Scan this QR code to submit meter readings</p>
                    <script type="text/javascript">
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        // Initial load
        loadSchemes();
        
        // Refresh schemes when page becomes visible (catches updates from other tabs)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadSchemes();
            }
        });
    </script>
</body>
</html>
