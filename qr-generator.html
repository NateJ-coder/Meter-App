<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator - Fuzio Meter Readings</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">‚ö° Fuzio Meter Readings</div>
        <ul class="nav-links">
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="meters.html">Meter Register</a></li>
            <li><a href="qr-generator.html" class="active">QR Codes</a></li>
        </ul>
    </nav>

    <main class="container">
        <header class="page-header">
            <h1>QR Code Generator</h1>
            <p class="subtitle">Generate QR codes for meter reading access</p>
        </header>

        <section class="card">
            <div class="card-header">
                <h2>Select Building (Bulk Meter)</h2>
                <button class="btn btn-secondary" onclick="loadBuildings()">üîÑ Refresh Buildings</button>
            </div>
            <div class="form-group">
                <label for="building-select">Building</label>
                <select id="building-select" onchange="generateQR()">
                    <option value="">-- Select a building --</option>
                </select>
            </div>
            <div class="info-box" style="background: #e7f3ff; border-left-color: #2196F3;">
                <strong>‚ÑπÔ∏è One QR code per building</strong><br>
                Only the bulk meter gets a QR code. When scanned, it will walk the reader through capturing the bulk meter reading, then automatically proceed through all submeters in sequence.
            </div>
        </section>

        <section class="card" id="qr-output" style="display: none;">
            <h2>QR Code</h2>
            <div id="meter-info" class="info-box mb-2"></div>
            <div style="text-align: center; margin: 2rem 0;">
                <img id="qr-image" alt="QR Code" style="max-width: 300px; border: 1px solid #ccc; padding: 10px; background: white;">
            </div>
            <div class="form-group">
                <label>Reader URL</label>
                <input type="text" id="reader-url" readonly onclick="this.select()">
                <small class="form-help">Click to select and copy, or click the button below to test</small>
            </div>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="testReaderLink()">üîó Test Reader Link</button>
                <button class="btn btn-primary" onclick="downloadQR()">Download QR Code</button>
                <button class="btn btn-secondary" onclick="printQR()">Print QR Code</button>
            </div>
        </section>

        <section class="card">
            <h2>Instructions</h2>
            <ol>
                <li>Select a building from the dropdown</li>
                <li>A QR code will be generated for that building's bulk meter</li>
                <li><strong>For testing:</strong> Click "Test Reader Link" button to open in a new tab</li>
                <li>Download or print the QR code</li>
                <li>Attach the QR code to the building's bulk meter</li>
            </ol>
            <p class="text-muted mt-2">
                <strong>Workflow:</strong> When a reader scans the QR code, they'll capture the bulk meter reading first, then the app will automatically walk them through all submeters in sequence (based on unit numbers).
            </p>
            <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107; margin-top: 1rem;">
                <strong>‚ö†Ô∏è Current Limitation (localStorage skeleton):</strong><br>
                This skeleton uses browser localStorage, so QR codes only work when scanned <strong>on the same device and browser</strong> where meters were created.
                <br><br>
                <strong>For production:</strong> Add a backend (Phase 2) so data is accessible from any device. Then QR codes will work on field readers' phones.
                <br><br>
                <strong>For now:</strong> Use the "Test Reader Link" button to test the workflow on this computer.
            </div>
        </section>
    </main>

    <script type="module">
        import { storage } from './assets/storage.js';

        // Load buildings into dropdown (only buildings with bulk meters)
        window.loadBuildings = function() {
            const buildings = storage.getAll('buildings');
            const select = document.getElementById('building-select');
            
            // Clear existing options except the first placeholder
            select.innerHTML = '<option value="">-- Select a building --</option>';
            
            if (buildings.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'No buildings found. Create buildings in Meter Register first.';
                select.appendChild(option);
                return;
            }
            
            // Find buildings that have a bulk meter
            const buildingsWithBulk = buildings.filter(building => {
                const units = storage.getAll('units').filter(u => u.building_id === building.id);
                const unitIds = units.map(u => u.id);
                const bulkMeter = storage.getAll('meters').find(m => 
                    m.type === 'bulk' && unitIds.includes(m.unit_id)
                );
                return !!bulkMeter;
            });

            if (buildingsWithBulk.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'No buildings with bulk meters found.';
                select.appendChild(option);
                return;
            }
            
            buildingsWithBulk.forEach(building => {
                const scheme = storage.get('schemes', building.scheme_id);
                const units = storage.getAll('units').filter(u => u.building_id === building.id);
                const submeters = storage.getAll('meters').filter(m => 
                    m.type === 'submeter' && units.map(u => u.id).includes(m.unit_id)
                );
                
                let label = building.name;
                if (scheme) label = `${scheme.name} - ${label}`;
                label += ` (${submeters.length} submeters)`;
                
                const option = document.createElement('option');
                option.value = building.id;
                option.textContent = label;
                select.appendChild(option);
            });
        };

        window.generateQR = function() {
            const buildingId = document.getElementById('building-select').value;
            if (!buildingId) {
                document.getElementById('qr-output').style.display = 'none';
                return;
            }

            const building = storage.get('buildings', buildingId);
            const scheme = storage.get('schemes', building.scheme_id);
            
            // Find the bulk meter for this building
            const units = storage.getAll('units').filter(u => u.building_id === buildingId);
            const unitIds = units.map(u => u.id);
            const bulkMeter = storage.getAll('meters').find(m => 
                m.type === 'bulk' && unitIds.includes(m.unit_id)
            );buildingId = document.getElementById('building-select').value;
            const building = storage.get('buildings', buildingId);
            const link = document.createElement('a');
            link.href = qrImage.src;
            link.download = `building-qr-${building.name.replace(/\s+/g, '-')
                alert('No bulk meter found for this building');
                return;
            }

            // Count submeters
            const submeters = storage.getAll('meters').filter(m => 
                m.type === 'submeter' && unitIds.includes(m.unit_id)
            );
            
            // Build reader URL with bulk_meter_id
            const baseUrl = window.location.origin + window.location.pathname.replace('qr-generator.html', '');
            const readerUrl = `${baseUrl}reader.html?bulk_meter_id=${bulkMeter.id}`;
            
            // Generate QR code using API
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(readerUrl)}`;
            
            // Display building info
            let infoHtml = `<strong>Scheme:</strong> ${scheme ? scheme.name : 'Unknown'}<br>`;
            infoHtml += `<strong>Building:</strong> ${building.name}<br>`;
            infoHtml += `<strong>Bulk Meter:</strong> ${bulkMeter.meter_number}<br>`;
            infoHtml += `<strong>Submeters:</strong> ${submeters.length} units<br>`;
            infoHtml += `<strong>Total Steps:</strong> ${submeters.length + 1} (bulk + all submeters)`;
            
            document.getElementById('meter-info').innerHTML = infoHtml;
            document.getElementById('qr-image').src = qrApiUrl;
            document.getElementById('reader-url').value = readerUrl;
            document.getElementById('qr-output').style.display = 'block';
        };

        window.downloadQR = function() {
            const qrImage = document.getElementById('qr-image');
            const link = document.createElement('a');
            link.href = qrImage.src;
            link.download = `meter-qr-${document.getElementById('meter-select').value}.png`;
            link.click();
        };

        window.testReaderLink = function() {
            Buildings();
        
        // Refresh buildings when page becomes visible (catches updates from other tabs)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadBuilding
        window.printQR = function() {
            const qrImage = document.getElementById('qr-image').src;
            const meterInfo = document.getElementById('meter-info').innerHTML;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print QR Code</title>
                    <style>
                        body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
                        .info { text-align: left; margin: 1rem auto; max-width: 400px; }
                        img { max-width: 300px; margin: 1rem 0; }
                    </style>
                </head>
                <body>
                    <h1>Meter Reading QR Code</h1>
                    <div class="info">${meterInfo}</div>
                    <img src="${qrImage}" alt="QR Code">
                    <p>Scan this QR code to submit meter readings</p>
                    <script type="text/javascript">
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        // Initial load
        loadMeters();
        
        // Refresh meters when page becomes visible (catches updates from other tabs)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadMeters();
            }
        });
    </script>
</body>
</html>
