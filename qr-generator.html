<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator - Fuzio Meter Readings</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">‚ö° Fuzio Meter Readings</div>
        <ul class="nav-links">
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="meters.html">Meter Register</a></li>
            <li><a href="qr-generator.html" class="active">QR Codes</a></li>
        </ul>
    </nav>

    <main class="container">
        <header class="page-header">
            <h1>QR Code Generator</h1>
            <p class="subtitle">Generate QR codes for meter reading access</p>
        </header>

        <section class="card">
            <div class="card-header">
                <h2>Select Meter</h2>
                <button class="btn btn-secondary" onclick="loadMeters()">üîÑ Refresh Meters</button>
            </div>
            <div class="form-group">
                <label for="meter-select">Meter</label>
                <select id="meter-select" onchange="generateQR()">
                    <option value="">-- Select a meter --</option>
                </select>
            </div>
        </section>

        <section class="card" id="qr-output" style="display: none;">
            <h2>QR Code</h2>
            <div id="meter-info" class="info-box mb-2"></div>
            <div style="text-align: center; margin: 2rem 0;">
                <img id="qr-image" alt="QR Code" style="max-width: 300px; border: 1px solid #ccc; padding: 10px; background: white;">
            </div>
            <div class="form-group">
                <label>Reader URL</label>
                <input type="text" id="reader-url" readonly onclick="this.select()">
                <small class="form-help">Click to select and copy, or click the button below to test</small>
            </div>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="testReaderLink()">üîó Test Reader Link</button>
                <button class="btn btn-primary" onclick="downloadQR()">Download QR Code</button>
                <button class="btn btn-secondary" onclick="printQR()">Print QR Code</button>
            </div>
        </section>

        <section class="card">
            <h2>Instructions</h2>
            <ol>
                <li>Select a meter from the dropdown</li>
                <li>A QR code will be generated automatically</li>
                <li><strong>For testing:</strong> Click "Test Reader Link" button to open in a new tab</li>
                <li>Download or print the QR code</li>
                <li>Attach the QR code near the physical meter</li>
            </ol>
            <p class="text-muted mt-2">
                <strong>Note:</strong> Each QR code is unique to a specific meter. The reader will only be able to submit readings for that meter when they scan it.
            </p>
            <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107; margin-top: 1rem;">
                <strong>‚ö†Ô∏è Current Limitation (localStorage skeleton):</strong><br>
                This skeleton uses browser localStorage, so QR codes only work when scanned <strong>on the same device and browser</strong> where meters were created.
                <br><br>
                <strong>For production:</strong> Add a backend (Phase 2) so data is accessible from any device. Then QR codes will work on field readers' phones.
                <br><br>
                <strong>For now:</strong> Use the "Test Reader Link" button to test the workflow on this computer.
            </div>
        </section>
    </main>

    <script type="module">
        import { storage } from './assets/storage.js';

        // Load meters into dropdown
        window.loadMeters = function() {
            const meters = storage.getAll('meters');
            const select = document.getElementById('meter-select');
            
            // Clear existing options except the first placeholder
            select.innerHTML = '<option value="">-- Select a meter --</option>';
            
            if (meters.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'No meters found. Create meters in Meter Register first.';
                select.appendChild(option);
                return;
            }
            
            meters.forEach(meter => {
                const meterDetails = storage.getMeterWithDetails(meter.id);
                let label = `${meter.meter_type}: ${meter.meter_number}`;
                
                if (meterDetails.unit_name) {
                    label += ` - ${meterDetails.building_name} ${meterDetails.unit_name}`;
                } else if (meter.meter_type === 'BULK') {
                    const scheme = storage.get('schemes', meter.scheme_id);
                    label += ` - ${scheme ? scheme.name : 'Unknown'}`;
                }
                
                const option = document.createElement('option');
                option.value = meter.id;
                option.textContent = label;
                select.appendChild(option);
            });
        };

        window.generateQR = function() {
            const meterId = document.getElementById('meter-select').value;
            if (!meterId) {
                document.getElementById('qr-output').style.display = 'none';
                return;
            }

            const meter = storage.getMeterWithDetails(meterId);
            const scheme = storage.get('schemes', meter.scheme_id);
            
            // Build reader URL
            const baseUrl = window.location.origin + window.location.pathname.replace('qr-generator.html', '');
            const readerUrl = `${baseUrl}reader.html?meter_id=${meterId}`;
            
            // Generate QR code using API
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(readerUrl)}`;
            
            // Display meter info
            let infoHtml = `<strong>Scheme:</strong> ${scheme ? scheme.name : 'Unknown'}<br>`;
            if (meter.building_name) infoHtml += `<strong>Building:</strong> ${meter.building_name}<br>`;
            if (meter.unit_name) infoHtml += `<strong>Unit:</strong> ${meter.unit_name}<br>`;
            infoHtml += `<strong>Meter Type:</strong> ${meter.meter_type}<br>`;
            infoHtml += `<strong>Meter Number:</strong> ${meter.meter_number}<br>`;
            infoHtml += `<strong>Last Reading:</strong> ${meter.last_reading || 0} kWh`;
            
            document.getElementById('meter-info').innerHTML = infoHtml;
            document.getElementById('qr-image').src = qrApiUrl;
            document.getElementById('reader-url').value = readerUrl;
            document.getElementById('qr-output').style.display = 'block';
        };

        window.downloadQR = function() {
            const qrImage = document.getElementById('qr-image');
            const link = document.createElement('a');
            link.href = qrImage.src;
            link.download = `meter-qr-${document.getElementById('meter-select').value}.png`;
            link.click();
        };

        window.testReaderLink = function() {
            const readerUrl = document.getElementById('reader-url').value;
            if (readerUrl) {
                window.open(readerUrl, '_blank');
            }
        };

        window.printQR = function() {
            const qrImage = document.getElementById('qr-image').src;
            const meterInfo = document.getElementById('meter-info').innerHTML;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print QR Code</title>
                    <style>
                        body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; }
                        .info { text-align: left; margin: 1rem auto; max-width: 400px; }
                        img { max-width: 300px; margin: 1rem 0; }
                    </style>
                </head>
                <body>
                    <h1>Meter Reading QR Code</h1>
                    <div class="info">${meterInfo}</div>
                    <img src="${qrImage}" alt="QR Code">
                    <p>Scan this QR code to submit meter readings</p>
                    <script type="text/javascript">
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        // Initial load
        loadMeters();
        
        // Refresh meters when page becomes visible (catches updates from other tabs)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadMeters();
            }
        });
    </script>
</body>
</html>
