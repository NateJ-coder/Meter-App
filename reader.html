<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meter Reading Submission</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<main class="container">
  <header class="page-header">
    <h1>Meter Reading</h1>
    <p id="context-info" class="subtitle"></p>
  </header>

  <section class="card">
    <form id="reader-form">

      <div class="form-group">
        <label for="reading-value">Current Reading (kWh) *</label>
        <input type="number" id="reading-value" required step="0.01">
      </div>

      <div class="form-group">
        <label for="photo-ref">Meter Photo *</label>
        <input type="text" id="photo-ref" placeholder="Photo filename or description" required>
      </div>

      <div class="form-group">
        <label for="notes">Notes (optional)</label>
        <textarea id="notes" rows="3"></textarea>
      </div>

      <button type="submit" class="btn btn-primary">Submit Reading</button>

    </form>
  </section>

  <section id="error-message" class="card" style="display:none;">
    <h2>⚠️ Unable to load meter</h2>
    <p id="error-text"></p>
  </section>

  <section id="success-message" class="card" style="display:none;">
    <h2>✅ Submission received</h2>
    <p>Thank you. The office has received this reading.</p>
  </section>
</main>

<script type="module">
  import { storage } from './assets/storage.js';
  import { validation } from './assets/validation.js';
  import { getCurrentDateTime } from './assets/app.js';

  // --- Get URL params ---
  const params = new URLSearchParams(window.location.search);
  const meterId = params.get('meter_id');

  // --- Load meter details from storage ---
  function loadMeterContext() {
    if (!meterId) {
      showError('No meter ID provided in QR code.');
      return null;
    }

    const meter = storage.get('meters', meterId);
    if (!meter) {
      showError('Meter not found. Please contact the office.');
      return null;
    }

    // Get scheme details
    const scheme = storage.get('schemes', meter.scheme_id);
    
    // Get building and unit details (if UNIT meter)
    let buildingName = '';
    let unitName = '';
    if (meter.unit_id) {
      const unit = storage.get('units', meter.unit_id);
      if (unit) {
        unitName = unit.unit_number;
        const building = storage.get('buildings', unit.building_id);
        if (building) buildingName = building.name;
      }
    }

    // Check if there's an open cycle for this scheme
    const openCycle = storage.getOpenCycle(meter.scheme_id);
    if (!openCycle) {
      showError('No open reading cycle. Please contact the managing agent.');
      return null;
    }

    // Display context
    let contextText = `${scheme ? scheme.name : 'Unknown Scheme'}`;
    if (buildingName) contextText += ` - ${buildingName}`;
    if (unitName) contextText += ` - Unit ${unitName}`;
    contextText += ` | Meter: ${meter.meter_number}`;
    if (meter.last_reading) contextText += ` | Last Reading: ${meter.last_reading} kWh`;

    document.getElementById('context-info').textContent = contextText;

    return { meter, scheme, openCycle };
  }

  function showError(message) {
    document.getElementById('error-text').textContent = message;
    document.getElementById('reader-form').parentElement.style.display = 'none';
    document.getElementById('error-message').style.display = 'block';
  }

  // --- Initialize page ---
  const context = loadMeterContext();
  if (!context) {
    // Error already shown
  } else {
    // Handle submit
    document.getElementById('reader-form').addEventListener('submit', function (e) {
      e.preventDefault();

      const readingValue = parseFloat(document.getElementById('reading-value').value);
      const photoRef = document.getElementById('photo-ref').value;
      const notes = document.getElementById('notes').value;

      // Calculate consumption
      const consumption = validation.calculateConsumption(
        readingValue, 
        context.meter.last_reading
      );

      // Create reading record
      const readingData = {
        meter_id: meterId,
        cycle_id: context.openCycle.id,
        reading_value: readingValue,
        reading_date: getCurrentDateTime(),
        photo: photoRef,
        notes: notes,
        consumption: consumption,
        captured_by: 'QR Reader',
        flags: [],
        review_status: 'pending'
      };

      // Validate and generate flags
      readingData.flags = validation.validateReading(readingData);

      // Save to readings (using existing storage system)
      storage.create('readings', readingData);

      // Update meter's last reading
      storage.update('meters', meterId, { last_reading: readingValue });

      // UX feedback
      document.getElementById('reader-form').style.display = 'none';
      document.getElementById('success-message').style.display = 'block';
    });
  }
</script>

</body>
</html>
