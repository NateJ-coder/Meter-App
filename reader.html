<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meter Reading Submission</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<main class="container">
  <header class="page-header">
    <h1>Meter Reading</h1>
    <p id="context-info" class="subtitle"></p>
    <div id="progress-info" class="badge" style="display:none; font-size: 0.9rem; margin-top: 0.5rem;"></div>
  </header>

  <section class="card">
    <form id="reader-form">

      <div class="form-group">
        <label for="reading-value">Current Reading (kWh) *</label>
        <input type="number" id="reading-value" required step="0.01">
      </div>

      <div class="form-group">
        <label for="photo-ref">Meter Photo *</label>
        <input type="text" id="photo-ref" placeholder="Photo filename or description" required>
      </div>

      <div class="form-group">
        <label for="notes">Notes (optional)</label>
        <textarea id="notes" rows="3"></textarea>
      </div>

      <button type="submit" class="btn btn-primary">Submit Reading</button>

    </form>
  </section>

  <section id="error-message" class="card" style="display:none;">
    <h2>⚠️ Unable to load meter</h2>
    <p id="error-text"></p>
    <div class="info-box mt-2" style="background: #fff3cd; border-left-color: #ffc107;">
      <strong>Note for testing:</strong> This app currently uses localStorage (browser storage on this device only). 
      <br><br>
      <strong>To test the QR reader:</strong>
      <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
        <li>Open the QR code on the same device/browser where you created the meters</li>
        <li>OR: Right-click the QR code → Copy link → Paste in the same browser</li>
      </ul>
      <strong>For production use:</strong> This system needs a backend server so data is accessible from any device.
    </div>
  </section>

  <section id="success-message" class="card" style="display:none;">
    <h2>✅ All readings captured!</h2>
    <p>Thank you. The office has received all readings for this building.</p>
    <a href="index.html" class="btn btn-secondary mt-2">Return to Dashboard</a>
  </section>
</main>

<script type="module">
  import { storage } from './assets/storage.js';
  import { validation } from './assets/validation.js';
  import { getCurrentDateTime } from './assets/app.js';

  // --- Get URL params ---
  const params = new URLSearchParams(window.location.search);
  const bulkMeterId = params.get('bulk_meter_id');
  const buildingId = params.get('building_id');
  const currentIndex = parseInt(params.get('index') || '0');

  let workflowContext = null;

  // --- Load workflow context ---
  function loadWorkflowContext() {
    // Starting from bulk meter QR scan
    if (bulkMeterId && !buildingId) {
      const bulkMeter = storage.get('meters', bulkMeterId);
      if (!bulkMeter) {
        showError(`Bulk meter not found (ID: ${bulkMeterId}). Please ensure you're on the same device/browser where the meter was created.`);
        return null;
      }

      if (bulkMeter.type !== 'bulk') {
        showError('This QR code is not for a bulk meter. Please scan the building\'s bulk meter QR code.');
        return null;
      }

      // Get building from bulk meter's unit
      const unit = storage.get('units', bulkMeter.unit_id);
      if (!unit) {
        showError('Building information not found for this bulk meter.');
        return null;
      }

      const building = storage.get('buildings', unit.building_id);
      const scheme = storage.get('schemes', building.scheme_id);
      
      // Check open cycle
      const openCycle = storage.getOpenCycle(scheme.id);
      if (!openCycle) {
        showError('No reading cycle is currently open. The admin must open a new cycle before readings can be captured.');
        return null;
      }

      // Get all submeters for this building
      const allMeters = storage.getAll('meters');
      const buildingUnits = storage.getAll('units').filter(u => u.building_id === building.id);
      const unitIds = buildingUnits.map(u => u.id);
      const submeters = allMeters
        .filter(m => m.type === 'submeter' && unitIds.includes(m.unit_id))
        .sort((a, b) => {
          const unitA = storage.get('units', a.unit_id);
          const unitB = storage.get('units', b.unit_id);
          return unitA.unit_number.localeCompare(unitB.unit_number, undefined, { numeric: true });
        });

      return {
        bulkMeter,
        building,
        scheme,
        openCycle,
        submeters,
        currentIndex: 0,
        currentMeter: bulkMeter,
        totalMeters: submeters.length + 1 // bulk + all submeters
      };
    }

    // Continuing with submeters
    if (buildingId) {
      const building = storage.get('buildings', buildingId);
      const scheme = storage.get('schemes', building.scheme_id);
      const openCycle = storage.getOpenCycle(scheme.id);

      // Get all submeters again
      const allMeters = storage.getAll('meters');
      const buildingUnits = storage.getAll('units').filter(u => u.building_id === building.id);
      const unitIds = buildingUnits.map(u => u.id);
      const submeters = allMeters
        .filter(m => m.type === 'submeter' && unitIds.includes(m.unit_id))
        .sort((a, b) => {
          const unitA = storage.get('units', a.unit_id);
          const unitB = storage.get('units', b.unit_id);
          return unitA.unit_number.localeCompare(unitB.unit_number, undefined, { numeric: true });
        });

      // Determine which submeter we're on (index 1 = first submeter, 2 = second, etc.)
      const submeterIndex = currentIndex - 1;
      if (submeterIndex >= submeters.length) {
        // All done!
        showSuccess();
        return null;
      }

      const currentMeter = submeters[submeterIndex];

      return {
        bulkMeter: null,
        building,
        scheme,
        openCycle,
        submeters,
        currentIndex,
        currentMeter,
        totalMeters: submeters.length + 1
      };
    }

    showError('Invalid QR code. Please scan a bulk meter QR code to start.');
    return null;
  }

  // --- Display current meter context ---
  function displayMeterContext(context) {
    const meter = context.currentMeter;
    const unit = storage.get('units', meter.unit_id);
    
    let contextText = `${context.scheme.name} - ${context.building.name}`;
    
    if (context.currentIndex === 0) {
      // Bulk meter
      contextText += ` | BULK METER: ${meter.meter_number}`;
      document.getElementById('progress-info').textContent = `Step 1 of ${context.totalMeters}: Bulk Meter`;
    } else {
      // Submeter
      contextText += ` - Unit ${unit.unit_number} | Submeter: ${meter.meter_number}`;
      document.getElementById('progress-info').textContent = `Step ${context.currentIndex + 1} of ${context.totalMeters}: Submeter ${context.currentIndex}`;
    }
    
    if (meter.last_reading) {
      contextText += ` | Last: ${meter.last_reading} kWh`;
    }

    document.getElementById('context-info').textContent = contextText;
    document.getElementById('progress-info').style.display = 'inline-block';
    document.getElementById('progress-info').className = context.currentIndex === 0 ? 'badge badge-primary' : 'badge badge-info';
  }

  function showError(message) {
    document.getElementById('error-text').textContent = message;
    document.getElementById('reader-form').parentElement.style.display = 'none';
    document.getElementById('error-message').style.display = 'block';
  }

  function showSuccess() {
    document.getElementById('reader-form').parentElement.style.display = 'none';
    document.getElementById('success-message').style.display = 'block';
  }

  // --- Initialize page ---
  workflowContext = loadWorkflowContext();
  
  if (workflowContext) {
    displayMeterContext(workflowContext);

    // Handle submit
    document.getElementById('reader-form').addEventListener('submit', function (e) {
      e.preventDefault();

      const readingValue = parseFloat(document.getElementById('reading-value').value);
      const photoRef = document.getElementById('photo-ref').value;
      const notes = document.getElementById('notes').value;

      const meter = workflowContext.currentMeter;

      // Calculate consumption
      const consumption = validation.calculateConsumption(readingValue, meter.last_reading);

      // Create reading record
      const readingData = {
        meter_id: meter.id,
        cycle_id: workflowContext.openCycle.id,
        reading_value: readingValue,
        reading_date: getCurrentDateTime(),
        photo: photoRef,
        notes: notes,
        consumption: consumption,
        captured_by: 'QR Reader',
        flags: [],
        review_status: 'pending'
      };

      // Validate and generate flags
      readingData.flags = validation.validateReading(readingData);

      // Save to readings
      storage.create('readings', readingData);

      // Update meter's last reading
      storage.update('meters', meter.id, { last_reading: readingValue });

      // Move to next meter or finish
      const nextIndex = workflowContext.currentIndex + 1;
      
      if (nextIndex < workflowContext.totalMeters) {
        // Continue to next submeter
        const nextUrl = `reader.html?building_id=${workflowContext.building.id}&index=${nextIndex}`;
        window.location.href = nextUrl;
      } else {
        // All done!
        showSuccess();
      }
    });
  }
</script>

</body>
</html>
