<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuzio Electricity Readings - Dashboard</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <img src="assets/images/Fuzio logo.jpg" alt="Fuzio" class="nav-logo">
            <span>Fuzio Meter Readings</span>
        </div>
        <ul class="nav-links">
            <li><a href="index.html" class="active">Dashboard</a></li>
            <li><a href="meters.html">Meter Register</a></li>
            <li><a href="reading-cycle.html">Reading Cycle</a></li>
            <li><a href="review.html">Review</a></li>
            <li><a href="export.html">Export</a></li>
            <li><a href="qr-generator.html">QR Codes</a></li>
            <li id="dev-console-link" style="display:none;"><a href="dev-console.html">ðŸ”§ Dev</a></li>
        </ul>
        <div class="nav-user">
            <span id="user-name"></span>
            <button class="btn btn-secondary btn-sm" onclick="handleLogout()">Logout</button>
        </div>
    </nav>

    <main class="container">
        <!-- Onboarding Container (shown on first run) -->
        <div id="onboarding-container"></div>

        <!-- Dashboard Content (shown after onboarding or if data exists) -->
        <div id="dashboard-content">
            <header class="page-header">
                <h1>Dashboard</h1>
                <p class="subtitle">Monthly electricity meter reading workflow</p>
            </header>

            <!-- First-Time Checklist (shown until complete) -->
            <div id="first-time-checklist-container"></div>

            <!-- Setup Health Panel -->
            <section id="setup-health-container"></section>

            <!-- Current Cycle Summary -->
            <section class="card">
                <h2>Current Reading Cycle</h2>
                <div id="cycle-status-container">
                    <p class="text-muted">Loading cycle information...</p>
                </div>
            </section>

        <!-- Key Metrics -->
        <section class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="total-meters">0</div>
                <div class="metric-label">Total Meters</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="meters-read">0</div>
                <div class="metric-label">Meters Read</div>
            </div>
            <div class="metric-card warning">
                <div class="metric-value" id="meters-not-read">0</div>
                <div class="metric-label">Not Read</div>
            </div>
            <div class="metric-card danger">
                <div class="metric-value" id="flagged-readings">0</div>
                <div class="metric-label">Flagged</div>
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="card">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
                <a href="reading-cycle.html" class="btn btn-primary">Open New Cycle</a>
                <a href="reading-cycle.html#capture" class="btn btn-secondary">Capture Readings</a>
                <a href="review.html" class="btn btn-secondary">Review Exceptions</a>
                <a href="export.html" class="btn btn-secondary">Export Data</a>
                <button class="btn btn-danger" onclick="clearAllData()" style="margin-left: auto;">Clear All Data</button>
            </div>
        </section>

        <!-- Recent Activity -->
        <section class="card">
            <h2>Recent Cycles</h2>
            <div id="recent-cycles-container">
                <p class="text-muted">Loading recent cycles...</p>
            </div>
        </section>
        </div>
    </main>

    <script type="module" src="assets/app.js"></script>
    <script type="module">
        import { storage } from './assets/storage.js';
        import { auth } from './assets/auth.js';
        import { onboarding } from './assets/onboarding.js';
        import { setupHealth } from './assets/setup-health.js';
        import { firstTimeChecklist } from './assets/first-time-checklist.js';
        import { initializeSeedData } from './assets/app.js';

        // Check authentication
        if (!auth.isAuthenticated()) {
            window.location.href = 'login.html';
        }

        // Display user info
        const currentUser = auth.getCurrentUser();
        document.getElementById('user-name').textContent = currentUser.name;

        // Show dev console link for admins
        if (currentUser.role === 'admin') {
            document.getElementById('dev-console-link').style.display = 'block';
        }

        // Logout handler
        window.handleLogout = function() {
            if (confirm('Are you sure you want to logout?')) {
                auth.logout();
            }
        };

        // Initialize seed data on first run (disabled by default)
        // Uncomment the line below to enable seed data:
        // initializeSeedData();

        // Make storage globally available
        window.storage = storage;
        window.auth = auth;

        // Check if onboarding should be shown
        function initializePage() {
            const dashboardContent = document.getElementById('dashboard-content');
            const onboardingContainer = document.getElementById('onboarding-container');

            if (onboarding.shouldShowOnboarding()) {
                // First run - show onboarding wizard
                dashboardContent.style.display = 'none';
                onboarding.renderWizard('onboarding-container');
            } else {
                // Normal dashboard
                dashboardContent.style.display = 'block';
                onboardingContainer.style.display = 'none';

                // Show first-time checklist if not completed
                firstTimeChecklist.renderChecklist('first-time-checklist-container');

                // Show setup health panel
                setupHealth.renderHealthPanel('setup-health-container');

                // Load dashboard data
                loadDashboard();
            }
        }

        // Clear all data function
        window.clearAllData = function() {
            if (confirm('âš ï¸ WARNING: This will delete ALL data (schemes, buildings, units, meters, readings, cycles). This cannot be undone. Are you sure?')) {
                if (confirm('Really sure? This action is permanent.')) {
                    storage.clearAll();
                    // Also clear onboarding state
                    localStorage.removeItem('fuzio_onboarding_state');
                    alert('All data cleared. Refreshing page...');
                    location.reload();
                }
            }
        };

        // Load dashboard data
        function loadDashboard() {
            const cycles = storage.getAll('cycles');
            const readings = storage.getAll('readings');
            const meters = storage.getAll('meters');
            
            // Find open cycle
            const openCycle = cycles.find(c => c.status === 'OPEN');
            
            // Update cycle status
            const cycleStatusContainer = document.getElementById('cycle-status-container');
            if (openCycle) {
                const scheme = storage.get('schemes', openCycle.scheme_id);
                cycleStatusContainer.innerHTML = `
                    <div class="cycle-status open">
                        <div class="status-badge">OPEN</div>
                        <div>
                            <strong>${scheme ? scheme.name : 'Unknown Scheme'}</strong>
                            <br>
                            <span class="text-muted">${openCycle.start_date} to ${openCycle.end_date}</span>
                        </div>
                    </div>
                `;
            } else {
                cycleStatusContainer.innerHTML = `
                    <div class="cycle-status closed">
                        <div class="status-badge">NO OPEN CYCLE</div>
                        <p class="text-muted">Open a new reading cycle to start capturing readings.</p>
                        <a href="reading-cycle.html" class="btn btn-primary">Open Cycle</a>
                    </div>
                `;
            }

            // Calculate metrics
            const unitMeters = meters.filter(m => m.meter_type === 'UNIT');
            const totalMeters = unitMeters.length;
            
            let metersRead = 0;
            let flaggedCount = 0;
            
            if (openCycle) {
                const cycleReadings = readings.filter(r => r.cycle_id === openCycle.id);
                metersRead = new Set(cycleReadings.map(r => r.meter_id)).size;
                flaggedCount = cycleReadings.filter(r => r.flags && r.flags.length > 0).length;
            }

            document.getElementById('total-meters').textContent = totalMeters;
            document.getElementById('meters-read').textContent = metersRead;
            document.getElementById('meters-not-read').textContent = totalMeters - metersRead;
            document.getElementById('flagged-readings').textContent = flaggedCount;

            // Load recent cycles
            const recentCycles = cycles
                .sort((a, b) => new Date(b.start_date) - new Date(a.start_date))
                .slice(0, 5);

            const recentCyclesContainer = document.getElementById('recent-cycles-container');
            if (recentCycles.length === 0) {
                recentCyclesContainer.innerHTML = '<p class="text-muted">No cycles found. Create your first cycle.</p>';
            } else {
                recentCyclesContainer.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Scheme</th>
                                <th>Period</th>
                                <th>Status</th>
                                <th>Readings</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentCycles.map(cycle => {
                                const scheme = storage.get('schemes', cycle.scheme_id);
                                const cycleReadings = readings.filter(r => r.cycle_id === cycle.id);
                                const statusClass = cycle.status === 'OPEN' ? 'badge-success' : 'badge-secondary';
                                return `
                                    <tr>
                                        <td>${scheme ? scheme.name : 'Unknown'}</td>
                                        <td>${cycle.start_date} to ${cycle.end_date}</td>
                                        <td><span class="badge ${statusClass}">${cycle.status}</span></td>
                                        <td>${cycleReadings.length} readings</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }
        }

        // Initialize page on load
        initializePage();
    </script>
</body>
</html>
